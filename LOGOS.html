<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX Transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>

    <!-- Firebase App & Services CDNs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
      
      body {
        font-family: 'Plus Jakarta Sans', sans-serif;
      }
      .font-serif {
        font-family: 'Playfair Display', serif;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // Map global objects from CDNs
      const { useState, useEffect } = React;
      const { 
        Heart, MapPin, Image: ImageIcon, CheckCircle, Download, 
        Send, PlusCircle, Clock, Trash2, Globe, HardDrive, 
        Images, Settings 
      } = lucideReact;

      // --- Configuration Placeholders ---
      // IMPORTANT: Replace the empty strings below with your actual Firebase config 
      // if you are deploying this outside of the Canvas environment.
      const firebaseConfig = {}; 
      const appId = 'wedding-invite-manager';

      // Initialize Firebase (Compat version for easier global usage)
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // Helper to handle Google Drive image links
      const getDirectDriveUrl = (url) => {
        if (!url) return '';
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (match && match[1]) {
          return `https://lh3.googleusercontent.com/d/${match[1]}`;
        }
        return url;
      };

      const LOGO_URL = getDirectDriveUrl("https://drive.google.com/file/d/1A9ZVt5Fbh-r2aRnb79-x_6Fj10YVQ4O8/view?usp=sharing");
      const AVAILABLE_LANGUAGES = ["English", "Arabic", "French", "Italian", "Spanish", "German", "Turkish"];

      const App = () => {
        const [user, setUser] = useState(null);
        const [submissions, setSubmissions] = useState([]);
        const [loading, setLoading] = useState(false);
        const [submitted, setSubmitted] = useState(false);
        const [showAdminTools, setShowAdminTools] = useState(false);

        const [formData, setFormData] = useState({
          brideName: '', groomName: '', weddingDate: '',
          languages: ["English", "Arabic"],
          events: [{ id: Date.now(), title: 'Wedding Ceremony', time: '', venue: '', address: '', maps: '' }],
          heroImageUrl: '', galleryPhotos: ['', '', '', '', '', ''],
          driveLink: '', rsvpDeadline: '', hashtag: '', specialNotes: ''
        });

        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged((user) => {
            if (user) {
              setUser(user);
            } else {
              auth.signInAnonymously();
            }
          });
          return () => unsubscribe();
        }, []);

        useEffect(() => {
          if (!user) return;
          const submissionsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions');
          const unsubscribe = submissionsRef.onSnapshot(
            (snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setSubmissions(data.sort((a, b) => {
                const timeA = a.submittedAt?.toMillis() || 0;
                const timeB = b.submittedAt?.toMillis() || 0;
                return timeB - timeA;
              }));
            },
            (error) => console.error("Firestore error:", error)
          );
          return () => unsubscribe();
        }, [user]);

        const handleLanguageToggle = (lang) => {
          setFormData(prev => ({
            ...prev,
            languages: prev.languages.includes(lang) 
              ? prev.languages.filter(l => l !== lang) 
              : [...prev.languages, lang]
          }));
        };

        const handleGalleryChange = (index, value) => {
          const newGallery = [...formData.galleryPhotos];
          newGallery[index] = value;
          setFormData({ ...formData, galleryPhotos: newGallery });
        };

        const handleEventChange = (index, field, value) => {
          const newEvents = [...formData.events];
          newEvents[index][field] = value;
          setFormData({ ...formData, events: newEvents });
        };

        const addEvent = () => {
          setFormData({
            ...formData,
            events: [...formData.events, { id: Date.now(), title: 'New Event', time: '', venue: '', address: '', maps: '' }]
          });
        };

        const removeEvent = (index) => {
          if (formData.events.length <= 1) return;
          setFormData({ ...formData, events: formData.events.filter((_, i) => i !== index) });
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          setLoading(true);
          try {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').add({
              ...formData,
              userId: user.uid,
              submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            setSubmitted(true);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } catch (err) {
            console.error("Error saving:", err);
          } finally {
            setLoading(false);
          }
        };

        const downloadCSV = () => {
          if (submissions.length === 0) return;
          const headers = ["Bride", "Groom", "Date", "Languages", "Hashtag", "Hero Image", "Drive Link", "Submitted At"];
          const escape = (s) => `"${(s || '').toString().replace(/"/g, '""')}"`;
          const rows = submissions.map(s => [
            escape(s.brideName), escape(s.groomName), escape(s.weddingDate),
            escape(s.languages?.join(', ')), escape(s.hashtag), escape(s.heroImageUrl),
            escape(s.driveLink), escape(s.submittedAt?.toDate().toLocaleString() || 'N/A')
          ]);
          const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ETERNEL_Data_${new Date().toISOString().slice(0,10)}.csv`;
          a.click();
        };

        const InputField = ({ label, icon: Icon, type = "text", value, onChange, placeholder, required = true }) => (
          <div className="flex flex-col gap-1.5">
            <label className="text-sm font-bold text-slate-600 flex items-center gap-2">
              {Icon && <Icon size={14} className="text-rose-400" />}
              {label}
            </label>
            <input
              type={type}
              className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-rose-100 focus:border-rose-400 outline-none transition-all placeholder:text-slate-300 text-slate-700 font-medium"
              value={value}
              onChange={onChange}
              placeholder={placeholder}
              required={required}
            />
          </div>
        );

        if (submitted) {
          return (
            <div className="min-h-screen bg-[#fafbfc] flex items-center justify-center p-4">
              <div className="bg-white p-12 rounded-[3rem] shadow-2xl max-w-lg w-full text-center border border-rose-50">
                <CheckCircle className="text-rose-500 mx-auto mb-6" size={64} />
                <h2 className="text-4xl font-serif font-bold text-slate-900 mb-4">Success!</h2>
                <p className="text-slate-500 mb-10">We've received your questionnaire. Your digital invitation is being prepared.</p>
                <button onClick={() => setSubmitted(false)} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all">
                  Submit New Client
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-[#fcfdfe] text-slate-900">
            <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-slate-100 px-6 py-4">
              <div className="max-w-6xl mx-auto flex justify-between items-center">
                <div className="flex items-center gap-4">
                  <img src={LOGO_URL} alt="Eternel Logo" className="h-10 w-auto object-contain rounded-md" />
                  <div>
                    <h1 className="font-serif text-2xl font-black text-slate-800 leading-none">ETERNEL<span className="text-rose-500">.EG</span></h1>
                    <p className="text-[10px] uppercase tracking-widest font-black text-slate-400">Design Portal</p>
                  </div>
                </div>
                <button onClick={() => setShowAdminTools(!showAdminTools)} className={`p-2 rounded-xl transition-all ${showAdminTools ? 'bg-rose-50 text-rose-500' : 'text-slate-400 hover:bg-slate-50'}`}>
                  <Settings size={20} />
                </button>
              </div>
            </nav>

            <main className="max-w-4xl mx-auto px-6 py-12 pb-32">
              <header className="text-center mb-16 space-y-4">
                <h2 className="text-5xl font-serif font-bold text-slate-900">Design Intake</h2>
                <p className="text-slate-500 text-lg">Detailed specifications for custom wedding websites.</p>
              </header>

              <form onSubmit={handleSubmit} className="space-y-12">
                <section className="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                  <div className="flex items-center gap-4 mb-8">
                    <div className="w-10 h-10 bg-rose-50 text-rose-500 rounded-xl flex items-center justify-center font-bold">01</div>
                    <h3 className="text-2xl font-serif font-bold text-slate-800">The Basics</h3>
                  </div>
                  <div className="grid md:grid-cols-2 gap-8 mb-10">
                    <InputField label="Bride's Name" value={formData.brideName} onChange={e => setFormData({...formData, brideName: e.target.value})} />
                    <InputField label="Groom's Name" value={formData.groomName} onChange={e => setFormData({...formData, groomName: e.target.value})} />
                    <InputField label="Wedding Date" type="date" value={formData.weddingDate} onChange={e => setFormData({...formData, weddingDate: e.target.value})} />
                  </div>
                  <div className="space-y-4">
                    <label className="text-sm font-bold text-slate-600 flex items-center gap-2"><Globe size={14} className="text-rose-400" /> Languages</label>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                      {AVAILABLE_LANGUAGES.map(lang => (
                        <button key={lang} type="button" onClick={() => handleLanguageToggle(lang)} className={`px-4 py-2.5 rounded-xl text-sm font-bold transition-all border-2 ${formData.languages.includes(lang) ? 'bg-rose-500 border-rose-500 text-white' : 'bg-white border-slate-100 text-slate-400'}`}>{lang}</button>
                      ))}
                    </div>
                  </div>
                </section>

                <section className="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                  <div className="flex items-center justify-between mb-8">
                    <div className="flex items-center gap-4"><div className="w-10 h-10 bg-rose-50 text-rose-500 rounded-xl flex items-center justify-center font-bold">02</div><h3 className="text-2xl font-serif font-bold text-slate-800">Itinerary</h3></div>
                    <button type="button" onClick={addEvent} className="text-rose-500 font-bold hover:bg-rose-50 px-4 py-2 rounded-xl flex items-center gap-2"><PlusCircle size={18} /> Add Event</button>
                  </div>
                  <div className="space-y-8">
                    {formData.events.map((event, idx) => (
                      <div key={event.id} className="p-8 rounded-3xl bg-slate-50/50 border border-slate-100">
                        <div className="flex justify-between items-center mb-6">
                          <input value={event.title} onChange={e => handleEventChange(idx, 'title', e.target.value)} className="bg-transparent border-none p-0 font-bold text-slate-800 text-lg focus:ring-0" />
                          {formData.events.length > 1 && <button type="button" onClick={() => removeEvent(idx)} className="text-slate-300 hover:text-rose-500"><Trash2 size={18} /></button>}
                        </div>
                        <div className="grid md:grid-cols-2 gap-6">
                          <InputField label="Time" value={event.time} onChange={e => handleEventChange(idx, 'time', e.target.value)} />
                          <InputField label="Venue" value={event.venue} onChange={e => handleEventChange(idx, 'venue', e.target.value)} />
                          <InputField label="Maps Link" required={false} value={event.maps} onChange={e => handleEventChange(idx, 'maps', e.target.value)} />
                          <InputField label="Address" required={false} value={event.address} onChange={e => handleEventChange(idx, 'address', e.target.value)} />
                        </div>
                      </div>
                    ))}
                  </div>
                </section>

                <section className="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                  <div className="flex items-center gap-4 mb-8"><div className="w-10 h-10 bg-rose-50 text-rose-500 rounded-xl flex items-center justify-center font-bold">03</div><h3 className="text-2xl font-serif font-bold text-slate-800">Media</h3></div>
                  <div className="space-y-8">
                    <InputField icon={ImageIcon} label="Hero Image URL" value={formData.heroImageUrl} onChange={e => setFormData({...formData, heroImageUrl: e.target.value})} />
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {formData.galleryPhotos.map((photo, idx) => (
                        <input key={idx} type="text" className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs" placeholder={`Gallery Photo ${idx+1}`} value={photo} onChange={e => handleGalleryChange(idx, e.target.value)} />
                      ))}
                    </div>
                    <InputField icon={HardDrive} label="Drive Folder Link" required={false} value={formData.driveLink} onChange={e => setFormData({...formData, driveLink: e.target.value})} />
                    <div className="grid md:grid-cols-2 gap-8">
                      <InputField label="RSVP Deadline" type="date" value={formData.rsvpDeadline} onChange={e => setFormData({...formData, rsvpDeadline: e.target.value})} />
                      <InputField label="Hashtag" required={false} value={formData.hashtag} onChange={e => setFormData({...formData, hashtag: e.target.value})} />
                    </div>
                  </div>
                </section>

                <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-6 rounded-[2rem] font-black text-xl hover:bg-slate-800 shadow-2xl disabled:opacity-50 flex items-center justify-center gap-3">
                  {loading ? 'Processing...' : (<>Finalize & Submit <Send size={20} /></>)}
                </button>
              </form>

              {showAdminTools && (
                <div className="mt-20 p-10 bg-slate-900 rounded-[3rem] text-white animate-in slide-in-from-bottom-10">
                  <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div className="space-y-2 text-center md:text-left">
                      <h4 className="text-2xl font-serif font-bold">Data Management</h4>
                      <p className="text-slate-400">Download collected responses for processing.</p>
                    </div>
                    <div className="flex flex-col gap-2 w-full md:w-auto">
                      <button onClick={downloadCSV} className="flex items-center justify-center gap-3 bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-2xl font-bold shadow-xl">
                        <Download size={20} /> Download CSV
                      </button>
                      <p className="text-[10px] text-center text-slate-500 font-bold uppercase tracking-widest">Total Entries: {submissions.length}</p>
                    </div>
                  </div>
                </div>
              )}
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
